#!/bin/bash

clear

# ===========================
# PAPIA CLOUD ASCII LOGO
# ===========================
echo "██████╗  █████╗ ██████╗ ██╗ █████╗       ██████╗██╗      ██████╗ ██╗   ██╗██████╗"
echo "██╔══██╗██╔══██╗██╔══██╗██║██╔══██╗     ██╔═══██╗██║     ██╔═══██╗██║   ██║██╔══██╗"
echo "██████╔╝███████║██║  ██║██║███████║     █████╗ ██║     ██████╔╝██║   ██║██████╔╝"
echo "██╔═══╝ ██╔══██║██║  ██║██║██╔══██║     ██╔══╝ ██║     ██╔═══╝ ██║   ██║██╔═══╝"
echo "██║     ██║  ██║██████╔╝██║██║  ██║     ██║    ███████╗██║     ╚██████╔╝██║    "
echo "╚═╝     ╚═╝  ╚═╝╚═════╝ ╚═╝╚═╝  ╚═╝     ╚═╝    ╚══════╝╚═╝      ╚═════╝ ╚═╝    "
echo
echo "~~~~~~~~~~~~~    PAPIA CLOUD – Dragon • Power • Speed • Sky    ~~~~~~~~~~~~~"
echo

echo "=== PAPIA CLOUD | Pterodactyl Register Installer ==="
echo

cd /var/www/pterodactyl || { echo "Pterodactyl folder not found!"; exit 1; }

echo "=== Updating system ==="
sudo apt update -y

echo "=== Installing PHP 8.4 + required extensions ==="
sudo apt install -y php8.4 php8.4-cli php8.4-fpm php8.4-mysql php8.4-zip php8.4-xml php8.4-bcmath php8.4-curl php8.4-gd php8.4-mbstring php8.4-intl unzip curl

echo "=== Installing Node 18 ==="
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

echo "=== Checking versions ==="
node -v
npm -v

echo "=== Installing Composer if missing ==="
composer -V || (
  curl -sS https://getcomposer.org/installer -o composer-setup.php
  sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
)

echo "=== Installing Pterodactyl Register Addon ==="
composer require wemx/pterodactylregister

echo "=== Clearing Laravel Cache ==="
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

echo "=== Running Register Installer ==="
php artisan register:install

echo "=== Installing NPM dependencies ==="
npm install --legacy-peer-deps

echo "=== Building Pterodactyl frontend ==="
npm run build:production

echo "=== Restarting services ==="
sudo systemctl restart nginx
sudo systemctl restart php8.4-fpm

echo "=== Setting Permissions ==="
sudo chown -R www-data:www-data /var/www/pterodactyl
sudo chmod -R 755 /var/www/pterodactyl

echo
echo "==============================================================="
echo "     PAPIA CLOUD Register Installed Successfully!"
echo "     Visit your panel and open:  /register"
echo "==============================================================="
